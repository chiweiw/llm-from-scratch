华夏理财产品运营管理系统-紧急流程预警详细需求规格说明书

1. 业务概述

对产品运营管理系统已提交、未完成的各项产品流程进行监控。若系统日期/时间达到“临界时点”，则通过企业微信提醒相关人员。

\--------------------------------------------------------------------------------

2. 批处理作业一：通用流程紧急预警

2.1 执行规则

• **执行日期**：银行间日历的所有工作日。

• **触发时点**：每日 **9:00、11:00、13:00、15:00、17:00**。

• **触发逻辑**：当前系统时间 ≥ 流程临界时点。

2.2 流程监控范围与临界时点定义 (N为产品工作日)

| 流程名称             | 临界时点定义                                                 | 备注                 |
| -------------------- | ------------------------------------------------------------ | -------------------- |
| **产品发行审批**     | 募集起始日 T-1 日零点                                        |                      |
| **产品申报登记**     | 公募：募集起始日（从）T-10 日零点；私募：T-2 日零点          | **银行间工作日计算** |
| **产品发行登记**     | 募集开始日 T-1 日 13:00                                      | **银行间工作日计算** |
| **产品发行前变更**   | 募集开始日 T-2 日 13:00                                      |                      |
| **产品暂停发行**     | 募集起始日 T-2 日 13:00                                      |                      |
| **产品定价管理**     | 生效日期（起）T-3 日 13:00                                   |                      |
| **增发份额**         | 份额计划成立日 T-3 日 13:00                                  |                      |
| **销售相关信息变更** | 生效日期 T-3 日 13:00                                        |                      |
| **开放计划调整**     | 1.临时开放：新增开放日最早日期 T-3 日 13:00；2.规则调整：变化最早日期 T-3 日 13:00 |                      |
| **分红方案管理**     | 除权除息日 T-3 日 13:00                                      |                      |
| **产品到期日变更**   | 调整后到期日 T-3 日 13:00                                    |                      |

2.3 接收消息提醒用户矩阵

*(注：若当前处于领导节点，仅领导个人不发，其他定义人员照常接收)*

| 流程类型         | 流程场景                                         | 发起人 | 待办 | 投资/销售经理 | 产品经理/岗        | 申报/发行/信披 |
| ---------------- | ------------------------------------------------ | ------ | ---- | ------------- | ------------------ | -------------- |
| **发行审批**     | 流程未过提交部门审批节点                         | √      | √    | √             | -                  | -              |
|                  | 在部门/公司审批节点                              | √      | √    | √             | **产品管理岗全员** | 申报√ / 信披√  |
|                  | 其他情况                                         | √      | √    | √             | 流程中产品经理     | 申报√ / 信披√  |
| **发行前变更**   | 流程未过提交部门审批节点                         | √      | √    | √             | -                  | -              |
|                  | 在部门/公司审批节点                              | √      | √    | √             | **产品管理岗全员** | 申报√ / 信披√  |
|                  | 其他情况                                         | √      | √    | √             | 流程中产品经理     | 申报√ / 信披√  |
| **暂停发行**     | 所有场景                                         | √      | √    | √             | **产品管理岗全员** | 申报√ / 信披√  |
| **申报登记**     | 所有场景                                         | -      | √    | -             | -                  | -              |
| **发行登记**     | 所有场景                                         | -      | √    | -             | -                  | -              |
| **产品定价管理** | **部门领导流**：在部门领导审批节点               | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | **部门领导流**：其他情况                         | √      | √    | √             | -                  | -              |
|                  | **公司领导流**：在部门/公司审批节点              | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | **公司领导流**：其余场景（含未过/其他）          | √      | √    | √             | 流程中产品经理     | 信披√          |
|                  | **敏捷会流**：在部门审批/敏捷小组会/确认结果节点 | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | **敏捷会流**：其余场景（含未过/其他）            | √      | √    | √             | 流程中产品经理     | 信披√          |
| **增发份额**     | 流程未过提交部门审批节点                         | √      | √    | √             | -                  | -              |
|                  | 在部门/公司审批节点                              | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | 其他情况                                         | √      | √    | √             | 流程中产品经理     | 信披√          |
| **销售信息变更** | 流程在提交部门审批节点                           | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | 其余场景（含未过/其他）                          | √      | √    | √             | 流程中产品经理     | 信披√          |
| **开放计划调整** | 在部门/公司审批节点                              | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | 其余场景（含未过/其他）                          | √      | √    | √             | 流程中产品经理     | 信披√          |
| **分红方案管理** | **定期分红**                                     | -      | √    | √             | 流程中产品经理     | -              |
|                  | **不定期分红**：在待公司领导审批节点             | √      | √    | √             | **产品管理岗全员** | 信披√          |
|                  | **不定期分红**：其余场景                         | √      | √    | √             | 流程中产品经理     | 信披√          |
| **到期日变更**   | 在部门审批/敏捷会审议/确认结果节点               | √      | √    | √             | **产品管理岗全员** | -              |
|                  | 其他情况                                         | √      | √    | √             | 流程中产品经理     | -              |

> TODO：后续需将“申报/发行/信披”列拆分为“申报登记岗 / 发行登记岗 / 运管部信披岗”三列，并与最终 SQL 出参中的 `SEND_SB_REGISTER`、`SEND_ISSUE_REGISTER`、`SEND_DISC_INFO` 一一对应。

**实现备注：主告警 SQL 分支与脚本对应关系（当前已实现部分）**

- 分支 A：产品申报登记 (Sb)  
  - 独立脚本：`产品申报提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_sb`，`ALERT_TYPE = '申报登记提醒'`
- 分支 B：产品发行审批 (Issue)  
  - 独立脚本：`发行审批提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_issue`，`ALERT_TYPE = '发行审批提醒'`
- 分支 C：产品发行前变更 (PreChange)  
  - 独立脚本：后续如需新增，需参考本文件 2.2、2.3 及“发行审批”节点配置保持一致  
  - 合并脚本：`合并流程提醒.sql` 中 `target_prechange`，`ALERT_TYPE = '发行前变更提醒'`
- 分支 D：产品暂停发行 (Suspend)  
  - 独立脚本：`流程模板单个SQL\暂停发行提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_suspend`，`ALERT_TYPE = '暂停发行提醒'`
- 分支 E：产品发行登记 (IssueReg)  
  - 独立脚本：`流程模板单个SQL\发行登记提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_issue_reg`，`ALERT_TYPE = '发行登记提醒'`
- 分支 F：产品定价管理 (PriceAdjust)  
  - 独立脚本：`流程模板单个SQL\产品定价管理提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_price`，`ALERT_TYPE = '产品定价管理提醒'`
- 分支 D：产品暂停发行 (Suspend)  
  - 独立脚本：`暂停发行提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_suspend`，`ALERT_TYPE = '暂停发行提醒'`
- 分支 E：产品发行登记 (IssueReg)  
  - 独立脚本：`发行登记提醒.sql`  
  - 合并脚本：`合并流程提醒.sql` 中 `target_issue_reg`，`ALERT_TYPE = '发行登记提醒'`

2.4 SQL 出参定义与消息格式

• **出参**：`account` (接收账号), `CONTENT` (内容), `OPERATOR` ('SYSTEM'), `OPERATOR_ACCOUNT` ('SYSTEM'), `TRIGGER` ('定时消息提醒')，以及用于标记不同角色是否需要接收本次提醒的 5 个字段：`SEND_INITIATOR`、`SEND_INV_SALES`、`SEND_SB_REGISTER`、`SEND_ISSUE_REGISTER`、`SEND_DISC_INFO`。

• **5 个 SEND 字段含义与矩阵映射**：
  - `SEND_INITIATOR`：是否额外发送给流程发起人，对应“具体矩阵.txt”中各行的“流程发起人”列；若矩阵该列为“√”，则在合并 SQL 中通常置为 1（申报登记 / 发行登记流程除外）。
  - `SEND_INV_SALES`：是否额外发送给流程中的投资经理 / 销售经理，对应矩阵中的“流程中的投资经理”、“流程中的销售经理”两列，只要任一列为“√”，该字段在合并 SQL 中即为 1。
  - `SEND_SB_REGISTER`：是否额外发送给“申报登记岗”，对应矩阵中的“申报登记岗”列，仅当该列为“√”且当前流程场景（`SCENE_CODE`）属于相应行时才为 1。
  - `SEND_ISSUE_REGISTER`：是否额外发送给“发行登记岗”，对应矩阵中的“发行登记岗”列；目前矩阵中暂无为“√”的场景，因此在现有流程中该字段始终为 0，保留用于后续扩展。
  - `SEND_DISC_INFO`：是否额外发送给“运管部信披岗”，对应矩阵中的“运管部信披岗”列；在合并 SQL 中，分别按流程类型 + `SCENE_CODE` + 模板名称（如产品定价管理的不同审批流）精细控制，仅当矩阵相应行该列为“√”时才置为 1。



2.5 消息模板

【产品运营管理系统】紧急流程预警

流程类型：【产品发行审批、产品申报登记、产品到期日变更等】

产品名称：

发起部门：【如果为产品申报登记则取报备审批流程发起部门，如果为发行登记则取发行审批流程的发起部门，其余流程直接取发起部门】

当前环节：

待办人员：

业务生效日：【运作期变更流程取生效日字段（见f章节），其余流程取募集开始日】

 

当前流程已处于业务临界时点，请及时关注进度！

\--------------------------------------------------------------------------------

3. 批处理作业二：“合瑞”专项提醒

3.1 业务规则

• **触发时间**：产品成立当日 **9:00**（仅发送一次）。

• **过滤条件**：产品形态为“封闭式”且名称带“合瑞”。

3.2 发送定义

• **接收人**：杨波、李旭晨。

• **消息模板**：

  ◦ 标题：【产品运营管理系统】合瑞产品成立提醒

  ◦ 产品名称：{名称}

  ◦ 成立日期：{成立日期}

  ◦ 内容：产品已于今日成立，请及时确认一次性支付销售手续费的金额明细并核对。

\--------------------------------------------------------------------------------

4. 开发确认细节
5. **领导识别**：根据系统角色配置，SQL 需关联权限表过滤“部门领导”与“公司领导”角色对应的 Account。
6. **部门溯源**：申报登记取“报备审批流程”发起部门；发行登记取“发行审批流程”发起部门。
7. **产品管理岗**：开发时需通过角色 ID 关联 `sys_rbac_user` 表，拉取该角色下所有激活状态的用户。
8. **去重逻辑**：在 SQL 组装阶段使用 `DISTINCT` 或 `GROUP BY` 确保同一 `account` 在同一时点不重复收到同一流程的提醒。
9. **领导排除配置**：
    - **原理**：为避免打扰领导，系统维护了一份“领导黑名单” (`excluded_leaders`)。凡是生成的待办人账号在此名单中的，一律不发送告警。
    - **当前配置名单**：
        | 部门 | 领导1 (Account) | 领导2 (Account) |
        |---|---|---|
        | 固定收益投资部 | hxlcyangmu (杨牧) | N0002977 (贾志敏) |
        | 多资产投资部 | hxlcnichun (倪春) | N0002977 (贾志敏) |
        | 多策略投资部 | hxlcwangsha (王莎) | N0002977 (贾志敏) |
        | 组合投资部 | N0002979 (张晓华) | N0002977 (贾志敏) |
        | 资产创设部 | N0002980 (刘潇) | N0002977 (贾志敏) |
        | 策略创新部 | N0002981 (杨杰) | N0002977 (贾志敏) |
        | 产品营销部 | hxlczxh (张晓华2) | N0002977 (贾志敏) |
        | 运营管理部 | N0002982 (张怀珍) | N0002986 (毛伟) |
        | 客户体验部 | hxlcyanlv (严律) | - |
        | 投资研究部 | hxlcyqy (杨勤宇) | - |
        | 法律合规部 | hxlclifeng (李峰) | - |
        | 机构投资部 | hxlcdujianzhi (杜建智) | N0002977 (贾志敏) |
        | ESG事业部 | hxlcwhk (王汉魁) | - |
    - **实现方式**：SQL 中通过 `excluded_leaders` CTE 汇总上述账号，并使用 `WHERE ct.account NOT IN (SELECT account FROM excluded_leaders)` 进行过滤。



---

如何根据流程模板获取流程当前节点



select t1.TMPL_NAME,t1.R_ID  from SYS_WF_TEMPLATE t1 where t1.TMPL_NAME like '%产品申报登记%'
HXLC_产品申报登记_维护	07f1c81c6610416c94639399b4170d10
HXLC_产品申报登记_封闭式	494c21bd6f5843bd8c5f525472d52426
HXLC_产品申报登记	ce67dbc4d04540e2a2329f0be2d601c3


SYS_WF_TEMPLATE中的CFG_JSONZ字段是一个json字符串，包含了流程的所有节点信息。
