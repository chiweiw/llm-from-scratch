# 新增流程模块接入指南 (TODO)

本文档旨在记录添加新流程模块（以“发行审批”为例）的标准操作步骤。后续添加其他模块（如“存续期管理”等）时请严格遵循此流程。

## 1. 独立开发阶段 (Independent Development)

在合并到主告警脚本之前，必须先确保新模块的逻辑独立运行正常。

### [ ] 1.1 确认流程模板名称
查询 `SYS_WF_TEMPLATE` 表，找到新模块对应的 `TMPL_NAME`。
- **目标**: 确保能通过 `like '%关键字%'` 唯一锁定目标流程。
- **SQL 示例**:
  ```sql
  select * from SYS_WF_TEMPLATE where TMPL_NAME like '%发行审批%';
  ```
  ```sql
  -- 发行前变更示例
  select * from SYS_WF_TEMPLATE where TMPL_NAME like '%发行前变更%';
  ```

### [ ] 1.2 编写独立 SQL 脚本
复制 `发行审批提醒.sql` 作为模板，重命名为 `[新模块名称]提醒.sql`。

- **核心修改点**:
    1. **tmpl CTE**: 填入步骤 1.1 找到的模板名称。
    2. **[module]_raw CTE**:
        - 关联业务主表 (ODS表)。
        - **关键**: 必须获取部门字段，并命名为 `PRD_DEPT` (或 `FQBM` as `PRD_DEPT`)。这是为了后续自动过滤部门领导所必须的。
    3. **target_[module] CTE**:
        - 定义告警触发条件 (如 `datediff >= 3` 或临界时间判断)。
        - 确保输出列名与模板一致 (`PRD_CODE`, `PRD_NAME`, `ALERT_TYPE` 等)。
    4. **针对“产品发行前变更”模块补充约定**:
        - 临界时点参考需求文档：募集开始日 T-2 日 13:00 触发。
        - 建议 `ALERT_TYPE` 固定为 `'发行前变更提醒'`，便于在合并 SQL 中区分。
        - 接收人矩阵与“产品发行审批”一致，可复用场景化节点配置（如 `PRE_DEPT_APPR`、`WAIT_SUBMIT`、`OTHERS`）。

### [ ] 1.3 生成节点配置 (可选但推荐)

当新模块需要基于“当前节点所处阶段”来决定提示语或接收人时，应为其单独维护一个 `[module]_node_cfg` CTE。节点获取与归类逻辑与 `NODE_ID计算原理.md` 中描述的完全一致：

1. **从流程模板表读取 CFG_JSON**
   - 目标表: `SYS_WF_TEMPLATE`
   - 核心字段: `CFG_JSON`
   - 推荐使用脚本 `dump_prechange_nodes.py` 快速获取节点列表:
     ```bash
     # 示例：查看所有“产品定价管理”相关模板的节点
     python dump_prechange_nodes.py "%产品定价管理%" dev
     ```
   - 脚本内部逻辑：
     - 按 `TMPL_NAME like ?` 从 `SYS_WF_TEMPLATE` 读取 `CFG_JSON`。
     - 反序列化 JSON 后，遍历结构，定位 `type == "task"` 的节点。
     - 对每个任务节点，提取：
       - `id` 作为底层 `NODE_ID`
       - `text` 或 `parameters.taskName` 作为节点展示名称。

2. **根据业务规则将节点映射到场景**
   - 规则与发行审批共用，详见 `NODE_ID计算原理.md`：
     - 规则 A: 节点名为“发起”“提交需求”“复核需求”等初期动作 → `PRE_DEPT_APPR` (提交部门审批前)。
     - 规则 B: 节点名包含“提交部门审批”“提交公司审批”“待提交”等，需要经办人点击“提交”的 → `WAIT_SUBMIT`。
     - 规则 C: 节点名包含“审批”“领导”“会”“办结”等正式审批/会审节点 → `OTHERS`。

3. **在独立 SQL 中维护节点配置 CTE**
   - 以发行审批的 `issue_node_cfg` 或定价管理的 `price_node_cfg` 为模板：
     - 一行代表一个 `(TMPL_NAME, NODE_NAME)` 的精确匹配。
     - 按模板拆分配置块，便于后续维护。
   - 示例结构:
     ```sql
     [module]_node_cfg as (
         -- HXLC_XXX 模板
         select 'HXLC_XXX' as TMPL_NAME, '提交需求' as NODE_NAME, 'PRE_DEPT_APPR' as SCENE_CODE, '流程未过提交部门审批节点' as SCENE_NAME
         union all select 'HXLC_XXX', '复核需求', 'PRE_DEPT_APPR', '流程未过提交部门审批节点'
         union all select 'HXLC_XXX', '提交部门审批', 'WAIT_SUBMIT', '流程在提交部门审批节点或流程在提交公司审批节点'
         union all select 'HXLC_XXX', '公司领导审批', 'OTHERS', '其他情况'
         -- 其他节点同理追加
     )
     ```
   - 在当前待办 CTE 中通过 `TMPL_NAME + TASK_NAME` 关联该配置，获取 `SCENE_CODE` 和 `SCENE_NAME`，用于生成更精细的提示语或接收人角色。

### [ ] 1.4 编写独立测试脚本
复制 `verify_merged_alert.py` (或 `verify_issue_alert.py`)，重命名为 `verify_[新模块].py`。

- **修改点**:
    - `ALERT_SQL_FILE = '[新模块名称]提醒.sql'`
- **执行验证**:
    - 运行 `python verify_[新模块].py`。
    - 确认能查询出数据，且无字段错误。

---

## 2. 合并阶段 (Merge to Main SQL)

将验证通过的逻辑合并到 `合并流程提醒.sql`。

### [ ] 2.1 修改 `合并流程提醒.sql`
按顺序执行以下插入操作：

1. **模板定义 (tmpl CTE)**:
   在 `tmpl` CTE 的 `IN` 列表中追加新的模板名称。
   ```sql
   'HXLC_产品发行审批', 
   'HX_产品发行审批',
   'HXLC_新模块名称' -- 新增
   ```

2. **节点配置 (Optional)**:
   如果新模块需要特殊的节点映射（如将“发起”/“待提交部门领导审批”等节点归类到不同场景），请在当前统一的节点配置 CTE `issue_node_cfg` 中追加 `UNION ALL` 逻辑，并按 **`TMPL_NAME + NODE_NAME` 精确匹配**。当前已内置：
   - 发行审批: `HXLC_产品发行审批`、`HX_产品发行审批`
   - 发行前变更: `HXLC_产品发行前变更`

   节点映射不再依赖 `NODE_ID`，除非同一流程模板下存在同名节点冲突，否则仅通过模板名称和节点名称即可完成场景划分。若新模块的接收人矩阵为“所有场景一致”（如暂停发行、发行登记），则可以不在 `issue_node_cfg` 中新增映射。

3. **业务数据 (raw CTE)**:
   复制独立脚本中的 `[module]_raw` CTE，粘贴到 `issue_raw` 之后。

4. **目标逻辑 (target CTE)**:
   复制独立脚本中的 `target_[module]` CTE，粘贴到 `target_issue` 之后。

5. **合并集合 (combined_targets)**:
   在 `combined_targets` 中追加 `UNION ALL`:
   ```sql
   union all
   select * from target_[module]
   ```

6. **接收人角色逻辑 (Final Select)**:
   在最终 `SELECT` 的 `ROLE_TYPE` Case When 语句中增加判断：
   ```sql
   when ti.ALERT_TYPE = '新模块提醒' then '经办人/待办人'
   ```

7. **send_code 角色矩阵 (Final Select)**:
   - 在最终 `SELECT` 中为新模块补充 5 个 send 字段：
     `SEND_INITIATOR`（发起人）、`SEND_INV_SALES`（投资/销售经理）、`SEND_SB_REGISTER`（申报登记岗）、`SEND_ISSUE_REGISTER`（发行登记岗）、`SEND_DISC_INFO`（运管部信披岗）。
   - 赋值规则需严格对齐《流程提醒告警.md》中 2.3 “接收消息提醒用户矩阵”的配置（按 `ALERT_TYPE + SCENE_CODE` 维度拆分），避免简单全 0 或全 1。

8. **注释规范 (Comments)**:
   - 在文件头部“逻辑分支说明”中增加一条新模块的分支说明，例如：
     `-- D. 分支逻辑 D: 产品发行登记 (IssueReg) ...`
   - 在文件头部“功能”说明中同步追加新模块名称，例如：
     `-- 功能: 整合[...]、[新模块名称]的流程监控逻辑`
   - 在新模块分支的业务数据 CTE 前增加分支注释，例如：
     `-- 分支逻辑 D: 产品发行登记业务数据 (IssueReg)`


---

## 3. 验证与发布 (Verification)

### [ ] 3.1 验证部门与领导逻辑
- **检查点**: 确保新模块输出的 `PRD_DEPT` 值（如“固定收益投资部”）必须严格匹配 `dept_leader_cfg` CTE 中的 `DEPT_NAME`。
- **说明**: 只要部门名称匹配，系统会自动应用“领导黑名单”逻辑（不发给领导），**无需额外写代码**。
- **例外**: 如果是全新部门，需在 `dept_leader_cfg` 中手动增加一行该部门的领导配置。

### [ ] 3.2 执行最终测试
运行 `verify_merged_alert.py`。
- 确认新模块的数据包含在总结果中。
- 确认没有 SQL 语法报错（如漏掉逗号）。

### [ ] 3.3 提交发布
确认无误后，提交 `合并流程提醒.sql`。
