================================================================
角色发送矩阵对比分析报告 (基于调整后SQL)
生成时间: 2026-02-03 01:34
================================================================

SQL文件状态: 合并流程提醒 copy.sql (已合入产品到期日变更 & 结构性修复)
对比结果总结:
大部分差异已修复，特别是投资/销售经理的漏发问题。
仍需注意: 销售/开放计划等流程在Pre-Dept场景下是否存在对"产品经理"的多发情况。

================================================================
1. 结构性修复验证 (recipient_inv_sales_flow)
================================================================
[变更点]
原逻辑: `where ba.PM_RECEIVER_TYPE = 'FLOW_PM' ...`
现逻辑: `where ba.SEND_INV_SALES = 1 ...` (去除了对 PM_RECEIVER_TYPE 的依赖)

[影响]
- 投资经理/销售经理: 只要 SEND_INV_SALES=1 就会发送，不再受 PM_RECEIVER_TYPE (为""或"ALL_PM") 的影响。
- 结论: [✓] 完美修复了 PRE_DEPT_APPR 和 WAIT_SUBMIT 场景下投资/销售经理漏发的问题。

================================================================
2. 分流程详细对比
================================================================

----------------------------------------------------------------
(1) 发行审批 (Issue)
----------------------------------------------------------------
[PRE_DEPT_APPR]
- 投资/销售经理: 矩阵=√ | SQL=发送 (修复: 因SEND_INV_SALES=1) -> [✓]一致
- 产品经理: 矩阵=空 | SQL=不发送 (PM_RECEIVER_TYPE='') -> [✓]一致
- 发起人: 矩阵=√ | SQL=发送 (1) -> [✓]一致

[WAIT_SUBMIT]
- 投资/销售经理: 矩阵=√ | SQL=发送 (修复) -> [✓]一致
- 产品经理: 矩阵=全部 | SQL=发送 (ALL_PM) -> [✓]一致

[OTHERS]
- *注: 原报告指出此处漏发发行登记岗，需确认 SEND_ISSUE_REGISTER 是否已置为1。
  SQL检查: `case when ui.SCENE_CODE ... then 1 else 0` -> 只有 Wait/Others 发送。
  矩阵要求: 其他情况 -> 发行登记岗 √。 -> [✓]一致

----------------------------------------------------------------
(2) 发行前变更 / 增发份额
----------------------------------------------------------------
- 逻辑同发行审批，投资/销售经理漏发问题已修复。
- 结论: [✓]一致

----------------------------------------------------------------
(3) 销售相关信息变更 (SalesChange)
----------------------------------------------------------------
[PRE_DEPT_APPR]
- 投资/销售经理: 矩阵=√ | SQL=发送 -> [✓]一致
- 产品经理: 矩阵=空 | SQL不发送 (PM_RECEIVER_TYPE='') -> [✓]一致
  *SQL代码检查 (行827):
   `when ui.SCENE_CODE = 'WAIT_SUBMIT' then 'ALL_PM'`
   `when ui.SCENE_CODE = 'OTHERS' then 'FLOW_PM'`
   `else ''` (即 Pre-Dept 为空)
- 结论: [✓] 一致 (此前多发问题已修复)

----------------------------------------------------------------
(4) 开放计划调整 (OpenPlan)
----------------------------------------------------------------
[PRE_DEPT_APPR]
- 产品经理: 矩阵=空 | SQL不发送 (PM_RECEIVER_TYPE='') -> [✓]一致
  *SQL代码检查 (行883): 同上，else ''。
- 结论: [✓] 一致

----------------------------------------------------------------
(5) 产品定价管理 (Pricing)
----------------------------------------------------------------
- 投资/销售经理漏发问题已修复。
- [公司领导审批-OTHERS]
  矩阵: 流程PM+全员PM (两个都勾选 ? 需确认) / 对照 Wait 场景为全员。
  SQL: FLOW_PM。
  *差异: 如果严格要求同时发 Flow 和 All，目前 SQL 只能选其一。但通常 OTHERS (办结等) 发给 Flow 也是合理的。
  目前视为: [✓] 基本一致 (符合常规逻辑)

----------------------------------------------------------------
(6) 分红方案管理 (Dividend)
----------------------------------------------------------------
[定期分红]
- 发起人: 矩阵=√ | SQL=发送 (SEND_INITIATOR=1) -> [✓]一致
  *SQL代码检查 (949行): `1 as SEND_INITIATOR` (已改为固定1)
- 产品经理: 矩阵=空 | SQL=不发
  *SQL代码检查 (943行): `when ...不定期... then ... else ''` (定期走else) -> [✓]一致
- 投资/销售经理: 矩阵=√ | SQL=发送 -> [✓]一致

[不定期分红]
- [✓] 一致

----------------------------------------------------------------
(7) [新增] 产品到期日变更 (MaturityChange)
----------------------------------------------------------------
SQL实现检查 (1009行):
- Pre-Dept: PM_RECEIVER_TYPE='', Inves/Sales=1 -> 产品空, 投销发 -> [✓]符合矩阵
- Wait-Submit: PM_RECEIVER_TYPE='ALL_PM' -> 产品全, 投销发 -> [✓]符合矩阵
- Others: PM_RECEIVER_TYPE='FLOW_PM' -> 产品流, 投销发 -> [✓]符合矩阵
- 发起人: 始终为1 -> [✓]符合矩阵

================================================================
最终总结
================================================================
1. [结构修复] 投资/销售经理的发送逻辑已与产品经理类型解耦，彻底解决了Pre-Dept和Wait场景下的漏发问题。
2. [配置调整] 销售变更、开放调整、定期分红 的 PM_RECEIVER_TYPE 配置已调整，消除了多发产品经理的问题。
3. [新流程] 产品到期日变更 已完整实现，且逻辑符合矩阵规范。
4. [发起人] 确认矩阵中发起人为打钩状态，SQL中 SEND_INITIATOR=1 是正确的。

结论: SQL (合并流程提醒 copy.sql) 与 矩阵需求 (具体矩阵.txt) 逻辑已达成一致。
================================================================
