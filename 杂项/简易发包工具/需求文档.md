一、需求文档：本地打包 → SSH 上传 → 远程执行重启脚本
1. 背景

该方案旨在为本地小团队提供一键自动化部署流程：通过Maven进行本地打包，将生成的JAR包上传到远程服务器，并通过远程执行脚本实现重启。所有操作均通过命令行执行，且确保过程无交互式界面，输出清晰的日志。

2. 核心功能

前置校验：确保每个步骤符合要求，若失败立即终止，输出错误日志。

Maven 打包：在本地执行 Maven 命令进行打包。

Jar 上传：通过 SSH 上传生成的 JAR 包到目标服务器。

远程重启：通过 SSH 执行远程服务器的重启脚本。

日志输出：全程清晰的日志输出，每个步骤的执行结果实时显示。

3. 配置区（极简配置）
CONFIG = {
    # 本地配置（核心）
    "local": {
        "project_root": r"D:\your_actual_project",  # 项目根目录（pom.xml所在路径）
        "jar_name": "trust-fund-1.0.jar",  # 打包后生成的Jar包名称
        "mvn_params": [  # Maven打包命令（根据实际路径设置）
            "clean", "package",
            "-DskipTests",
            "-s", r"D:\java_tools\apache-maven-3.9.12\conf\settings_sgt0903.xml",  # settings.xml路径
            "-Dmaven.repo.local=D:\m2\repository"  # 本地仓库路径
        ]
    },
    # 服务器配置（SSH+重启脚本）
    "server": {
        "host": "192.168.8.26",  # 目标服务器IP
        "port": 22,              # SSH端口
        "username": "ch",        # 服务器用户名
        "password": "your_password",  # 服务器密码
        "remote_jar_dir": "/opt/app/",  # 服务器Jar包存放目录
        "restart_sh_cmd": "/opt/app/restart.sh"  # 重启脚本路径
    },
    # 全局超时设置（用于Maven、SSH连接等）
    "timeout": 600  # 默认超时时间设置为600秒
}
4. 功能流程与步骤
4.1 前置校验（确保每一步能正常执行）

Maven有效性校验：

校验 mvn.cmd 是否存在并可执行。

校验本地 Maven 配置是否正确，settings_sgt0903.xml 和仓库路径是否有效。

项目目录有效性校验：

校验 project_root 指定目录存在，并且 pom.xml 文件存在。

Jar 输出目录合法性校验：

校验 remote_jar_dir（远程目标目录）是否存在。

若目录不存在或不可写，自动创建该目录并进行权限校验。

服务器网络连通性校验：

校验本地是否能 ping 通目标服务器 IP，且 SSH 端口（默认 22）可访问。

SSH 登录有效性校验：

使用指定用户名和密码验证 SSH 登录有效性。

若登录失败，提示具体原因并终止流程。

服务器目标目录有效性校验：

检查远程 remote_jar_dir 是否有效，是否有权限写入文件。

服务器脚本有效性校验：

检查重启脚本 restart_sh_cmd 是否存在且具备可执行权限。

4.2 核心执行流程（前置校验通过后执行）

执行 Maven 打包：

运行指定 Maven 命令（如 clean package），输出日志并校验打包返回码是否为 0。

校验打包是否生成 JAR 文件，且文件大小大于 0（排除空文件）。

SSH 上传 Jar 包：

使用 paramiko 通过 SSH 上传本地生成的 JAR 包到指定服务器路径 remote_jar_dir。

远程执行重启脚本：

通过 SSH 远程执行服务器上的重启脚本 restart_sh_cmd。

校验脚本执行的返回码和输出日志，确保重启脚本执行成功。

日志输出：

所有操作步骤输出日志，若任意步骤失败，立刻终止并输出错误日志。

5. 风险管理与容错设计

风险点1：密码明文存储

风险：密码以明文存储在脚本中，可能导致安全问题。

解决方案：改为运行时输入密码，或使用环境变量存储密码。

风险点2：Maven 打包超时

风险：Maven 打包时间不确定，可能超时或失败。

解决方案：使用超时机制（如 timeout）控制 Maven 打包的最大时间。

风险点3：Jar 文件丢失或空文件

风险：生成的 Jar 包文件大小为 0 或丢失。

解决方案：校验打包后的 Jar 包存在且文件大小大于 0，若不符合要求则终止流程。

风险点4：SSH 连接失败

风险：可能由于网络不稳定、服务器端口问题或认证失败，导致 SSH 连接失败。

解决方案：在 SSH 登录和上传文件时，进行超时控制，并在失败时输出具体错误信息。

风险点5：重启脚本阻塞

风险：如果重启脚本需要 sudo 权限，且没有配置好，可能会导致脚本无法执行。

解决方案：确保远程脚本可执行，并能够通过 sudo 执行，或提前确认权限。

6. 错误处理与终止规则

前置校验失败：任何前置校验失败，立即终止流程并输出具体错误信息。

打包失败：若 Maven 打包失败（返回码非 0），输出打包日志并终止流程。

Jar 文件异常：如果 Jar 包不存在或文件大小为 0，终止流程并提示错误信息。

SSH 连接 / 上传失败：若 SSH 登录失败或文件上传失败，终止流程并输出错误原因。

重启脚本失败：若重启脚本执行失败，输出执行日志和退出码，终止流程。

全流程成功：若每个步骤都成功，输出“打包 - 上传 - 重启全流程完成”的成功信息。

7. 最终需求文档
# 自动化打包 → 上传 → 重启脚本执行流程

## 目标

- 在本地执行 Maven 打包，打包成功后上传生成的 JAR 包到指定服务器，最后远程执行重启脚本。

## 核心步骤

### 1. 前置校验

- 检查本地 Maven 环境和路径
- 校验项目目录和 pom.xml 文件
- 校验 Jar 包输出目录并确保可写
- 检查服务器网络连通性和 SSH 连接
- 确认目标服务器的目录和重启脚本有效性

### 2. Maven 打包

- 使用配置的 Maven 命令打包项目
- 校验打包成功并生成 Jar 文件

### 3. 上传 Jar 包

- 使用 SSH 上传生成的 Jar 包至服务器指定目录

### 4. 执行远程重启脚本

- 远程执行重启脚本，确保执行成功

### 5. 错误与终止规则

- 任何步骤失败都会终止流程，并输出详细错误信息


-- 下面是idea 打包命令，请注意，这是参考，你要调整为mvn打包
D:\Program Files\JetBrains\IntelliJ IDEA 2025.3.3\plugins\maven\lib\maven3\bin\mvn.cmd -Didea.version=2025.3.3 -Dmaven.ext.class.path=D:\Program Files\JetBrains\IntelliJ IDEA 2025.3.3\plugins\maven\lib\maven-event-listener.jar -Djansi.passthrough=true -Dstyle.color=always -s D:\java_tools\apache-maven-3.9.12\conf\settings_sgt0903.xml -Dmaven.repo.local=D:\m2\repository package -f pom.xml
