# 后端计算与校验逻辑设计


## 一、 全局前置校验逻辑（优先级最高）

在计算具体某个流程是否可发起前，后端需首先进行全局状态拦截：

### 1. "暂停发行"流程拦截

- **校验目标**：查询工作流活动表 `sys_app_wf_activity`，判断当前产品是否存在任务名称为"暂停发行"且 `ACTIVITY_STATE = '1'`（在办）的实例。
- **结果处理**：若存在，直接返回拦截信号及提示文案："产品正在暂停发行，无法发起新的流程"。

### 2. 产品状态过滤

- **校验目标**：查询产品主表（对应SQL中 `fx` 关联的 `ods_prdyz_issue_info`）。
- **结果处理**：若 `产品状态 = 发行失败` 或 `终止`，后端应返回该产品不可进行任何流程发起操作。

---

## 二、 具体流程发起准入计算（**isAllow 逻辑**）

后端需根据"当前进度"枚举值及关联业务表的记录状态，为弹窗中的每个按钮计算 `isAllow` 状态（0-可点击，-1-置灰）。

### 1. 产品发行管理模块

#### 产品申报登记

- **计算逻辑**：以"产品代码"为索引，查询申报登记业务表。若存在状态为"待发起"的记录，则 `isAllow = '0'` 并返回该记录 ID；否则 `isAllow = '-1'`。

#### 产品发行审批

- **计算逻辑**：
  1. 校验 `当前进度` 不属于 {发行审批, 已发行, 已成立, 已到期, 产品预申报}。
  2. 同时查询工作流表，确保【产品发行审批】功能中不存在 `ACTIVITY_STATE = '1'` 的未完结流程。
- **结果**：同时满足以上两点则 `isAllow = '0'`，否则 `isAllow = '-1'`。

### 2. 产品运作管理模块（通用逻辑与冲突校验）

#### 通用准入条件

- `当前进度` 必须处于 {发行审批, 已发行, 已成立} 阶段。
- `产品状态` 必须不等于"发行失败"。

#### 二次弹窗冲突计算（重要）

- 在发起增发、定价、开放计划、销售变更流程时，后端需额外查询是否存在任务名称为"产品到期日变更"且未完结的流程实例。
- **结果**：若存在，后端需下发特定的提示标识，前端据此弹出文案："产品到期日变更流程未结束，请关注"。

#### 特定流程增强校验

- **分红方案管理**：额外要求 `当前进度 = 已成立`。
- **投资范围变更**：额外要求 `当前进度` 属于 {已发行, 已成立}。
- **开放计划调整**：额外要求 `产品形态` 属于 {定期开放, 申赎不同步, 封闭式}。

### 3. 销售文件与运营管理

#### 产品说明书制作

- **计算逻辑**：校验 `当前进度` 不属于 {报备审批, 申报登记, 产品预申报}。
- **分支处理**：满足进度后，查询是否存在同代码待发起记录。若有，返回记录 ID 以打开待办；若无，则标记为"新建"模式。

#### 临时公告管理

- **计算逻辑**：查询公告业务表，若存在待发起记录则 `isAllow = '0'`。
- **多条处理**：若存在多条待办，后端需对比"平台日"与"披露日历"，计算并返回距离当前时间最近的一条记录 ID。

---

## 三、 后端表关联关系参考（基于SQL示例重构）

为实现上述计算，后端逻辑需建立以下关联：

### 1. 业务主表关联

- `sb (ods_prdtq_cpsbxxgl_info)`：用于获取初始报备状态及审议结果。
- `pq (ods_prdtq_schedule)`：用于校验是否有有效的发行排期数据。
- `fx (ods_prdyz_issue_info)`：获取产品的最新发行状态及"当前进度"。

### 2. 工作流状态关联

- `sys_app_wf_activity`：通过 `INSTANCE_ID` 关联各业务主表，通过 `ACTIVITY_STATE = '1'` 判定流程是否"在途"。
- 需定义各流程对应的 `TASK_ID`（如示例中的 'd702058a...'），用于区分是发行审批、到期日变更还是增发流程。

### 3. 计算输出

- 后端接口应针对每个按钮返回一个 JSON 对象，包含：`actionName`（流程名）、`isAllow`（0/-1）、`tips`（置灰原因或预警提示）、`targetId`（跳转的目标业务 ID）。
